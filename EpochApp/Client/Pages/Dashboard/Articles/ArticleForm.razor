@using ButtonType=MudBlazor.ButtonType
@using Position=MudBlazor.Position
@using Variant=MudBlazor.Variant
@using MudBlazor
@using EpochApp.Components.Forms
@inherits RequestComponent<ArticleEditDTO>

@if (Model != null)
{
	<EditForm Model="@Model" OnSubmit="@OnArticleSubmit">
		<EpochValidator @ref=@_validator />

		<MudTabs Border="true" Color="Color.Info" Outlined="true" Rounded="true" PanelClass="pa-2" KeepPanelsAlive="false" Position="Position.Left">

			<MudTabPanel ID="@("ArticleContent")" Icon="@Icons.Material.Filled.Article" Text="Article">

				<MudGrid Spacing="2">

					<AuthorizeView Roles="ADMIN,INTERNAL" Context="AuthCtx">
						<Authorized>
							<MudItem xs="12" md="6">
								<MudTextField Adornment="@Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Warning" AdornmentColor="Color.Warning" Label="WorldId" @bind-Value="@Model.WorldId" For="@(() => Model.WorldId)" ReadOnly="true" />
							</MudItem>

							<MudItem xs="12" md="6">
								<MudTextField Adornment="@Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Warning" AdornmentColor="Color.Warning" Label="AuthorId" @bind-Value="@Model.AuthorId" For="@(() => Model.AuthorId)" ReadOnly="true" />
							</MudItem>
						</Authorized>
					</AuthorizeView>

					<MudItem xs="12" md="6">
						<MudTextField Label="Title" @bind-Value="@Model.Title" For="@(() => Model.Title)" MaxLength="255" Required="true" />
					</MudItem>

					<MudItem xs="12" md="6">

						<MudStack>
							<MudSelect FullWidth="true" T="int" Label="Category" @bind-Value="@Model.CategoryId" For="@(() => Model.CategoryId)" Required="true" Placeholder="Please choose a category for this article...">
								@if (_categories.Any())
								{
									@foreach (var cat in _categories)
									{
										<MudSelectItem Value="@cat.CategoryID">@cat.Description</MudSelectItem>
									}
								}
							</MudSelect>
							<MudButton OnClick="@(async () => await GenerateArticleTemplateAsync())">Generate Article Template</MudButton>
						</MudStack>
					</MudItem>

					<MudItem xs="12">
						<EpochMarkup @bind-MarkupString="@Model.Content" For="@(() => Model.Content)" />
						@* <MudTextField Lines="5" Label="Content" @bind-Value="@Model.Content" For="@(() => Model.Content)" /> *@
					</MudItem>

				</MudGrid>

			</MudTabPanel>

			<MudTabPanel ID="@("ArticleSections")" Icon="@Icons.Material.Filled.LibraryBooks" Text="Sections">

				<MudGrid Spacing="2">

					<!-- Article Sections -->
					<MudItem xs="12">
						<MudText>Article Sections</MudText>

						<MudExpansionPanels>
							@if (Model.Sections.Any())
							{
								@foreach (var sec in Model.Sections)
								{
									var secTemplate = _templateSections.FirstOrDefault(x => x.SectionName == sec.Title);
									<MudExpansionPanel @key=@sec Dense="true">
										<TitleContent>@sec.Title</TitleContent>
										<ChildContent>
											<MudGrid>
												<AuthorizeView Roles="ADMIN,INTERNAL" Context="SecAuthCtx">
													<Authorized>
														<MudItem xs="12" md="6">
															<MudTextField Adornment="@Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Warning" AdornmentColor="Color.Warning" Label="Section Id" @bind-Value="@sec.SectionId" For="@(() => sec.SectionId)" ReadOnly="true" />
														</MudItem>
													</Authorized>
												</AuthorizeView>

												<MudItem xs="12" sm="6">
													@if (secTemplate != null)
													{
														<MudTextField @bind-Value="@sec.Title" For="@(() => sec.Title)" Label="@secTemplate.SectionName" />
													}
													else
													{
														<MudTextField @bind-Value="@sec.Title" For="@(() => sec.Title)" Label="Section Header" />
													}
												</MudItem>
												<MudItem xs="12">
													@if (secTemplate != null)
													{
														<EpochMarkup @bind-MarkupString="@sec.Content" For="@(() => sec.Content)" Label="@secTemplate.SectionName" HelpText="@secTemplate.Description" />
													}
													else
													{
														<EpochMarkup @bind-MarkupString="@sec.Content" For="@(() => sec.Content)" Label="Section Content" />
													}
												</MudItem>
												<MudItem xs="12">
													<MudPaper Class="mt-2" Outlined="true" Width="100%">
														<MudToolBar Dense="false" DisableGutters="false" WrapContent="true">
															<MudSpacer />
															<MudTooltip Text="Saves your data to the database.">
																<MudButton OnClick="@(async () => await DeleteSectionAsync(sec))" Color="Color.Error" Size="Size.Small" IconColor="Color.Error" ButtonType="ButtonType.Button" EndIcon="@(Icons.Material.Filled.Delete)">Delete</MudButton>
															</MudTooltip>
														</MudToolBar>
													</MudPaper>
												</MudItem>
											</MudGrid>
										</ChildContent>
									</MudExpansionPanel>
								}
							}
						</MudExpansionPanels>
						<MudButton FullWidth="true" OnClick="@AddArticleSectionAsync" Variant="Variant.Text" EndIcon="@Icons.Material.Filled.AddCircle" IconColor="Color.Primary" ButtonType="ButtonType.Button" Color="Color.Primary">Add Section</MudButton>
					</MudItem>

				</MudGrid>

			</MudTabPanel>

			<MudTabPanel ID="@("ArticlePreferences")" Icon="@Icons.Material.Filled.Settings" Text="Preferences">

				<MudGrid Spacing="2">

					<MudItem xs="12">
						<MudSwitch Color="Color.Primary" @bind-Value="@Model.IsPublished" For="@(() => Model.IsPublished)" Label="@($"{(Model.IsPublished ? "Published" : "Unpublished")}")" />
					</MudItem>
					<MudItem xs="12">
						<MudSwitch Color="Color.Primary" @bind-Value="@Model.IsNSFW" For="@(() => Model.IsNSFW)" Label="@($"{(Model.IsNSFW ? "Not safe for work" : "Safe for work")}")" />
					</MudItem>
					<MudItem xs="12">
						<MudSwitch Color="Color.Primary" @bind-Value="@Model.ShowTableOfContents" For="@(() => Model.ShowTableOfContents)" Label="@($"{(Model.ShowTableOfContents ? "Display Table of Contents" : "No Table of Contents")}")" />
					</MudItem>
					<MudItem xs="12">
						<MudSwitch Color="Color.Primary" @bind-Value="@Model.ShowInTableOfContents" For="@(() => Model.ShowInTableOfContents)" Label="@($"{(Model.ShowInTableOfContents ? "Show in World Table of Contents" : "Do not display in World Table of Contents")}")" />
					</MudItem>

				</MudGrid>

			</MudTabPanel>

		</MudTabs>

		<MudPaper Class="mud-theme-dark mt-2" Outlined="true" Width="100%">
			<MudToolBar Dense="false" DisableGutters="false" WrapContent="true">
				<MudButton Color="Color.Inherit" Disabled="@(!IsEditMode)" Size="Size.Large" IconColor="@(IsEditMode ? Color.Warning : Color.Default)" StartIcon="@(Model.IsPublished ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)" OnClick="@(() => Model.IsPublished = !Model.IsPublished)">Publish</MudButton>
				<MudSpacer />
				<MudTooltip Text="Saves your data to the database.">
					<MudButton Color="Color.Inherit" Class="mr-5" Size="Size.Large" IconColor="Color.Primary" ButtonType="ButtonType.Submit" StartIcon="@($"{StaticUtils.AwesomeIcons.FontDict[AwesomeIconType.FloppyDisk]}")">Save</MudButton>
				</MudTooltip>
			</MudToolBar>
		</MudPaper>

	</EditForm>
}